<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>如何聚类并挑选类 | 小可的博客</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="../../../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../favicon-16x16.png">
    <link rel="manifest" href="../../../manifest.json">
    <link rel="mask-icon" href="../../../safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="../../../css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    
 
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="../../../">小可的博客</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="../../../archives/">文章</a>
  
    <a class="color-link nav-link" href="../../../categories/">分类</a>
  
    <a class="color-link nav-link" href="../../../tags/">标签</a>
  
    <a class="color-link nav-link" href="../../../about/">关于</a>
  
  <a class="color-link nav-link" href="../../../index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Google Scholar">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
             <path d="M15.7399177,5.48151786 C15.149924,4.82272859 14.4663239,4.49480724 13.6933878,4.49480724 C12.8185607,4.49480724 12.1471312,4.80966127 11.6791845,5.43796013 C11.2112379,6.06433732 10.9771365,6.82326666 10.9771365,7.71483354 C10.9771365,8.47423262 11.1052474,9.24733956 11.3616402,10.035649 C11.6170934,10.8236168 12.0350768,11.5270314 12.6210136,12.1470458 C13.2049434,12.7685974 13.8844439,13.0787968 14.6564833,13.0787968 C15.5171327,13.0787968 16.189459,12.7903763 16.671626,12.2137916 C17.1517432,11.6379755 17.3927199,10.9111166 17.3927199,10.035649 C17.3927199,9.29000051 17.2655484,8.50924961 17.0102233,7.69296927 C16.7561365,6.87562134 16.3319184,6.13812924 15.739875,5.48156056 L15.7399177,5.48151786 Z M24.3072528,4.96950105 L24.3072528,13.3462071 C24.3072528,13.7339989 23.9898792,14.0515006 23.6019592,14.0515006 L23.3422783,14.0515006 C22.9543156,14.0515006 22.6369848,13.7341271 22.6369848,13.3462071 L22.6369848,4.96950105 C22.6369848,4.62513879 22.5869788,4.33765779 23.068249,4.27714671 L23.068249,3.16262405 L19.3634081,6.20120253 C19.4061972,6.28058863 19.446851,6.33132057 19.4854124,6.39789556 C19.8110278,6.97418137 19.9768461,7.69087679 19.9768461,8.56681414 C19.9768461,9.23824368 19.8649625,9.84134739 19.638078,10.3740328 C19.4122611,10.9065473 19.1375912,11.3415267 18.817143,11.6765369 C18.496652,12.0127855 18.1752643,12.3201237 17.8538766,12.5967152 C17.5324462,12.8739047 17.2577763,13.162923 17.0328135,13.4629589 C16.8060571,13.7620125 16.6932767,14.0712297 16.6932767,14.3917206 C16.6932767,14.7126813 16.8397076,15.0387237 17.1317151,15.3673283 C17.4226551,15.6968724 17.7805972,16.0162103 18.2038758,16.3317049 C18.6279231,16.6450216 19.0510736,16.9928002 19.4743522,17.3712399 C19.8985703,17.74921 20.2545052,18.2354765 20.5454452,18.8259399 C20.8385631,19.4186239 20.9848231,20.071093 20.9848231,20.7882582 C20.9848231,21.7343577 20.7435475,22.5887297 20.2626616,23.3491963 C19.7802812,24.1064175 19.1518542,24.7106315 18.3796867,25.1537246 C17.6054695,25.599807 16.777531,25.9355858 15.8945476,26.1623422 C15.0097279,26.3870488 14.1317408,26.5 13.2548639,26.5 C12.7014246,26.5 12.1429889,26.4573818 11.5814359,26.3697112 C11.0178757,26.2822114 10.4532907,26.1276668 9.8847343,25.9098782 C9.31502485,25.6906377 8.81052389,25.4214338 8.37319577,25.0981672 C7.93475736,24.778146 7.58181166,24.3652016 7.3111559,23.862238 C7.04054285,23.3591036 6.90615445,22.7936645 6.90615445,22.1655364 C6.90615445,21.4203577 7.1136515,20.7291563 7.52975591,20.0847582 C7.94586031,19.4451002 8.49707907,18.9108775 9.18272893,18.487727 C10.3789864,17.7434877 12.2558547,17.2836547 14.8102164,17.1098936 C14.2262867,16.3799173 13.9333396,15.6928582 13.9333396,15.0498693 C13.9333396,14.6841125 14.0289531,14.2920503 14.218173,13.8687717 C13.9130554,13.9113899 13.5987992,13.9355175 13.2781801,13.9355175 C11.9059836,13.9355175 10.7472627,13.4894351 9.80628769,12.5911638 C8.86535538,11.6944724 8.39535897,10.5719642 8.39535897,9.21488479 C8.39535897,9.07298054 8.39941581,8.94802965 8.40970739,8.8095417 L2.83316537,8.8095417 L11.2417283,1.5 L25.1668346,1.5 L23.87996,2.50451805 L23.87996,4.27748834 C24.3577712,4.3388962 24.3072955,4.62607827 24.3072955,4.96950105 L24.3072528,4.96950105 Z M15.8172967,17.9839947 C15.6566455,17.9549562 15.430914,17.9386434 15.1399313,17.9386434 C14.512273,17.9386434 13.8947782,17.9941154 13.2885571,18.1048887 C12.6822934,18.2126727 12.084186,18.3947184 11.4941496,18.6515809 C10.9019353,18.906906 10.423996,19.2823566 10.0597766,19.7787865 C9.69355004,20.274576 9.51150436,20.858463 9.51150436,21.5303623 C9.51150436,22.1706609 9.67215551,22.7419077 9.99371402,23.2394479 C10.3142049,23.7338281 10.7373127,24.1208513 11.2632509,24.3980408 C11.7891891,24.6756999 12.3405787,24.8854176 12.916224,25.0231795 C13.4929795,25.1600875 14.0799412,25.2311463 14.6780913,25.2311463 C15.8610679,25.2311463 16.8794647,24.9647609 17.7338794,24.4320756 C18.5863724,23.899561 19.0135798,23.0772595 19.0135798,21.9672634 C19.0135798,21.7338025 18.9810823,21.5040141 18.916856,21.2796064 C18.8498112,21.0527219 18.7835352,20.8585057 18.7185829,20.6972567 C18.6534171,20.5389543 18.529363,20.3483679 18.3462498,20.1286576 C18.1642041,19.9083067 18.0248194,19.7455631 17.9310848,19.6372239 C17.8354714,19.5253403 17.6565431,19.3656714 17.3929761,19.1545445 C17.131587,18.9425209 16.9647012,18.8103104 16.8904822,18.7614574 C16.8172027,18.7100422 16.6270434,18.5711699 16.3207728,18.3458227 C16.0147157,18.1186393 15.8468903,17.9981723 15.8173394,17.983952 L15.8172967,17.9839947 Z"></path>
        </svg>
    </a>
    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="../../../js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">如何聚类并挑选类</h1>
    
    <time>June 5, 2020</time>
    
    <div>
        <p>
        <p>用来展示聚类三张图吧
<a href="https://mp.weixin.qq.com/s/_4lswhtg04_ctuIJYDhlJg"><strong>这篇文章</strong></a> 提到了聚类展示的三张图，这里定义展示一下，也是对聚类概念的加强和理解；
<a href="https://mp.weixin.qq.com/s/AvUHjcU7XoMMUFM0KlU3bw"><strong>原文地址</strong></a>
如何找到合适的聚类？</p>
<blockquote>
<p>不过我们可以基于不同聚类过程中使用的相似性算法和模块划分参数，选择一个最合适的数目。在K-means，PAM和层次聚类中选择合适的聚类数目，这些方法包括直接方法和统计检验方法。
1.<em>直接方法</em> 设置一些适合的划分标准，比如elbow和average silhouette法
2.<em>统计检验方法</em> 就是常用的假设检验方法，比如gap statistic</p>
</blockquote>
<pre><code class="language-{r}#" data-lang="{r}#"># 如果因为缺少某些包而安装失败，请先安装其他依赖包再重新安装，安装时间比较久
# 可能需要依赖lme4，cowplot，ggpubr，FactoMineR
# 其中cowplot需要R3.3版本，其他版本可以试试用下面命令安装
devtools::install_url(&quot;https://github.com/wilkelab/cowplot/archive/1.0.0.zip&quot;)
if(!require(devtools)) install.packages('devtools')
if(!require(factoextra)) devtools::install_github('kassambara/factoextra')
</code></pre><pre><code class="language-{r}#" data-lang="{r}#">#如果已经安装，跳过即可
pkgs &lt;- c(&quot;cluster&quot;,  &quot;NbClust&quot;)
install.packages(pkgs)
</code></pre><p>载入R包</p>
<pre><code class="language-{r}#" data-lang="{r}#">library(factoextra)
library(cluster)
library(NbClust)
</code></pre><p>准备数据</p>
<pre><code class="language-{r}#" data-lang="{r}#">data(iris)
head(iris)
</code></pre><pre><code class="language-{r}#" data-lang="{r}#"># remove species column
iris.scaled = scale(iris[,-5]) #scale 注意行 列，scale是对列进行操作
head(iris.scaled)
</code></pre><h2 id="1-三种聚类方法">1. 三种聚类方法</h2>
<h3 id="11-k-means-和-pama">1.1 k-means() 和 pama()</h3>
<p>这里演示了stat包中的k-means()，cluster包中的pama()的使用，把上面的归一化后的数据分成3个cluster。</p>
<pre><code class="language-{r}#" data-lang="{r}#"># K-means clustering
set.seed(123)
km.res = kmeans(iris.scaled, 3, nstart=25)
# k-means  group number of each observation
str(km.res)
km.res$cluster
</code></pre><pre><code class="language-{r}#" data-lang="{r}#"># visualize k-means result
fviz_cluster(km.res, data=iris.scaled, geom='point', stand=FALSE, ellipse.type='convex')
# convex / norm
</code></pre><pre><code class="language-{r}#" data-lang="{r}#"># PAM clustering
pam.res = pam(iris.scaled, 3)
# str(pam.res)
pam.res$cluster
</code></pre><pre><code class="language-{r}#" data-lang="{r}#"># visualize pam clusters
fviz_cluster(pam.res, stand=FALSE, geom='point', ellipse.type = 'norm')
</code></pre><h3 id="12-hclust">1.2 hclust()</h3>
<p>另一个是R中内建的方法hclust():</p>
<pre><code class="language-{r}#" data-lang="{r}#"># 计算两两间的距离，计算方法比较多，这里选择欧几里德距离
dist.res = dist(iris.scaled, method='euclidean')
# 进行层次聚类，不同的算法说明可以查看函数帮助信息
hc = hclust(dist.res, method='complete')
# 展示聚类结果
plot(hc, labels=FALSE, hang=-1, xlab='hclust')
# 为3个group添加方框，原来还有这个函数，真神奇
rect.hclust(hc, k=3, border=2:4)
</code></pre><pre><code class="language-{r}#" data-lang="{r}#"># 把层次聚类的结果分成3组 
hc.cut = cutree(hc,k=3)
hc.cut
</code></pre><h2 id="2-确定最佳分组数目的3种方法">2. 确定最佳分组数目的3种方法</h2>
<p>这里介绍3种常用的方法：<strong>Elbow method（肘部法则）</strong>，<strong>silhouette method</strong> 和 <strong>gap statistic</strong> 。</p>
<h3 id="21-elbow-method">2.1 Elbow method</h3>
<p>在聚类分割算法中，比如K-means聚类，为了确定不同的分类，需要保证每个类分组总变异量之和最小；
具体过程如下</p>
<blockquote>
</blockquote>
<p>1.对不同的k值，分别进行聚类。如K-means中k可以取从1到10
2.对每个k值，计算每个组的组内平方各（within-cluster sum of square）的和
3.绘制k值和组内平方和的总和的趋势图
4.从图上的转折点确定最佳分组数目</p>
<pre><code class="language-{r}#" data-lang="{r}#">#用kmeans看看
set.seed(123)  
# k值从2到15
k.max = 15
data = iris.scaled
# 这里不必手动计算平方总和，kmeans中已经完成计算，直接调用
wss = sapply(1:k.max,
            function(k){kmeans(data,k,nstart=10)$tot.withinss})
plot(1:k.max, wss,
    type='b', pch=19, frame=FALSE,
    xlab = 'Number of cluster K',
    ylab = &quot;Total within-clusters sum of squares&quot;)
abline(v=3, lty=2)
</code></pre><p>从上面的图，可以看出在k=3这个点上，曲线的变化率比较大，建议选择k=3作为最终的结果。当然你还可以看到k越大，组内平方和总和是越来越小，不过随着k变大，分类结果也更加分散，可能不能很好的表现数据聚类想要表达的信息。</p>
<p>也可以直接利用一个叫factoextra的R包来实现，使用它的提供的fviz_nbclust()函数</p>
<pre><code class="language-{r}#" data-lang="{r}#"># fviz_nbclust(x,FUNcluster,method=c('silhourtte','wss'))
fviz_nbclust(iris.scaled, kmeans, method='wss') + geom_vline(xintercept = 3, linetype=2)

# 这里貌似不能直接给出一个推荐值，需要我们自己从图中寻找一个，也就是k=3
</code></pre><p>下面试试用PAM聚类的结果进行测试</p>
<pre><code class="language-{r}#" data-lang="{r}#">fviz_nbclust(iris.scaled, pam, method='wss') + geom_vline(xintercept = 3, linetype=2)
</code></pre><p>最终结果也和k-means的聚类结果类似。最后再试试用层次聚类的结果来试试看。使用factoextra提供的 hcut对数据进行聚类并划分分组</p>
<pre><code class="language-{r}#" data-lang="{r}#">fviz_nbclust(iris.scaled, hcut, method='wss') + geom_vline(xintercept = 3, linetype=2)
</code></pre><p>如果数据比较复杂的话，Elbow method可能会陷入局部最优的结果，随着k的增大，wss反而又增大的情况。</p>
<h3 id="22-average-silhouette-method">2.2 Average silhouette method</h3>
<p>简单来说，该主方法用于评估聚类结果的质量。如果一个聚类的结果比较好，那么它的average silhouette就会比较高。计算过程类似Elbow method：</p>
<blockquote>
</blockquote>
<p>1.对不同的k值分别进行聚类
1.对每个k的聚类结果分别计算average silhouette（avg.sil）值
1.以k为x轴，avg.sil为y轴绘制连线图
1.avg.sil值最大处就是最优k值</p>
<p>具体的R执行代码可以利用cluster包中的silhouette()函数计算average silhouette值。先看看在K-means聚类中的使用</p>
<pre><code class="language-{r}" data-lang="{r}">library(cluster)
k.max = 15
data = iris.scaled
sil = rep(0, k.max)
# k从2到15分别进行kmeans 
for (i in 2:k.max){
    km.res = kmeans(data, centers=i, nstart = 25)
    ss = silhouette(km.res$cluster, dist(data))
    sil[i] = mean(ss[,3])
}
# 画图
plot(1:k.max, sil, type='b', pch=19, frame=FALSE, xlab='Number of clusters k')
abline(v=which.max(sil), lty=2)
</code></pre><p>使用前面用到的fviz_nbclust()完成</p>
<pre><code class="language-{r}" data-lang="{r}">fviz_nbclust(iris.scaled, kmeans, method='silhouette') #所以说这函数 标准化的数据、聚类方法和聚类评价方式
</code></pre><p>下面再介绍在PAM和层次聚类中使用</p>
<pre><code class="language-{r}" data-lang="{r}"># for PAM clustering  
fviz_nbclust(iris.scaled, pam, method='silhouette')
</code></pre><pre><code class="language-{r}" data-lang="{r}"># for hierarchical clustering
fviz_nbclust(iris.scaled, hcut, method='silhouette',hc_method='complete')
</code></pre><p>讨论:前面介绍的Elbow method得到的最佳值，需要我们手动去看，而Average silhouette method会直接提供一个最佳以供选择。而且K-means和PAM的推荐值是k=2，而层次聚类的推荐值是k=3。结合之前的Elbow method结果，设置k=3比较好。</p>
<h3 id="23-gap-statistic-method">2.3 Gap statistic method</h3>
<p>Gap statistic method可以运用到任何聚类算法里面。该方法先比较不同k值聚类结果中组内变异量的总和（total within intracluster variation）。
利用统计学的假设检验来比较TSS值与那些随机分布的参考数据集之间是否显著差异。</p>
<p>计算过程：（看不懂）</p>
<blockquote>
<p>根据不同的k值对实际数据进行聚类并计算$W_k$
产生B个参考数据集（bootstrap法），按照不同的k值进行聚类，并计算Gap值：$Gap(k)  = \frac{1}{B}\sum{b=1}^{B}log(Wk^*) - log(W_k)$
让$\bar{w} = (\frac{1}{B}\sum{b}log(W{kb}^))$，计算标准差$sd(k) =   \sqrt{\frac{1}{B}\sum_b(log(W_{kb}^)-\bar{w})^2}$和标准误$sk = sdk \times  \sqrt{1+\frac{1}{B}}$
选择满足$Gap(k) \ge Gap(k+1) - s_{k+1}$的最小k值</p>
</blockquote>
<p>R语言里面的实现方法可以利用cluster包中的 clusGap()来计算</p>
<pre><code class="language-{r}" data-lang="{r}"># clusGap(x, FUNcluster, K.max, B = 100, verbose = TRUE, ...)  
</code></pre><p>对3种聚类方法进行测试：</p>
<pre><code class="language-{r}" data-lang="{r}">library(cluster)
set.seed(123)
# 一般认为B=500就能得到一个比较好的结果，这里设为50以提高计算速度
gap_stat = clusGap(iris.scaled, FUN=kmeans, nstart=25, K.max=10, B=50)
print(gap_stat, method='firstmax')
</code></pre><pre><code class="language-{r}" data-lang="{r}"># 绘图
plot(gap_stat, frame=FALSE, xlab='Number of cluster k')
abline(v=3, lty=2)
</code></pre><pre><code class="language-{r}" data-lang="{r}"># 使用factoextra
fviz_gap_stat(gap_stat)
</code></pre><p>这里的最佳聚类数目是用firstmax方法（查看 ?cluster::maxSE）计算的，Tibshirani et al (2001)提出的方法可以参考下面脚本：</p>
<pre><code class="language-{r}" data-lang="{r}"># Print
print(gap_stat, method = &quot;Tibs2001SEmax&quot;)
# Plot
fviz_gap_stat(gap_stat, 
            maxSE = list(method = &quot;Tibs2001SEmax&quot;))
# Relaxed the gap test to be within two standard deviations
fviz_gap_stat(gap_stat, 
          maxSE = list(method = &quot;Tibs2001SEmax&quot;, SE.factor = 2))
</code></pre><p>PAM和层次聚类的结果</p>
<pre><code class="language-{r}" data-lang="{r}"># PAM聚类结果 
set.seed(123)
gap_stat &lt;- clusGap(iris.scaled, FUN = pam, K.max = 10, B = 50)
# Plot gap statistic
fviz_gap_stat(gap_stat)
</code></pre><pre><code class="language-{r}" data-lang="{r}"># Compute gap statistic
set.seed(123)
gap_stat &lt;- clusGap(iris.scaled, FUN = hcut, K.max = 10, B = 50)
# Plot gap statistic
fviz_gap_stat(gap_stat)
</code></pre><p>原文参考：</p>
<ol>
<li><a href="https://mp.weixin.qq.com/s/AvUHjcU7XoMMUFM0KlU3bw">Determining the optimal number of clusters: 3 must known methods - Unsupervised Machine Learning</a></li>
<li><a href="https://rstudio-pubs-static.s3.amazonaws.com/201598_e96ae3be88b64ba8baffb2923bfdf5c6.html">k-means Clustering</a></li>
<li><a href="https://rpubs.com/Felix/7445">K-means another case</a></li>
<li><a href="https://mp.weixin.qq.com/s/AvUHjcU7XoMMUFM0KlU3bw">如何选聚类</a></li>
</ol>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kkitown" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="../../../tags/r">#R</a>
        
            <a class="tag" href="../../../tags/%E8%81%9A%E7%B1%BB">#聚类</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="../../../css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="../../../js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="../../../js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Blogger">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M16.4225354,15.183099 C16.7605636,15.183099 17.0422536,15.3145545 17.2676055,15.5774654 C17.4929581,15.8028172 17.6056345,16.0845072 17.6056345,16.4225354 C17.6056345,16.7605636 17.4929581,17.0422536 17.2676055,17.2676055 C17.0422536,17.4929581 16.7605636,17.6056345 16.4225354,17.6056345 L11.5211272,17.6056345 C11.183099,17.6056345 10.9014088,17.4929581 10.6760564,17.2676055 C10.4507043,17.0422536 10.3380283,16.7605636 10.3380283,16.4225354 C10.3380283,16.0845072 10.4507043,15.8028172 10.6760564,15.5774654 C10.9014088,15.3145545 11.183099,15.183099 11.5211272,15.183099 L16.4225354,15.183099 Z M11.5211272,11.5774646 C11.183099,11.5774646 10.9014088,11.4647886 10.6760564,11.2394368 C10.4507043,11.0140849 10.3380283,10.7323948 10.3380283,10.3943664 C10.3380283,10.0563382 10.4507043,9.77464807 10.6760564,9.54929597 C10.9014088,9.3239438 11.183099,9.21126771 11.5211272,9.21126771 L14.6760568,9.21126771 C15.0140849,9.21126771 15.295775,9.3239438 15.5211268,9.54929597 C15.7464787,9.77464807 15.8591546,10.0563382 15.8591546,10.3943664 C15.8591546,10.7323948 15.7464787,11.0140849 15.5211268,11.2394368 C15.295775,11.4647886 15.0140849,11.5774646 14.6760568,11.5774646 L11.5211272,11.5774646 Z M18.7887323,11.5774646 L18.7887323,9.21126771 C18.7887323,8.23474189 18.431925,7.38967148 17.7183104,6.67605648 C17.004695,5.9624414 16.1596245,5.60563386 15.183099,5.60563386 L10.3943663,5.60563386 C9.41784045,5.60563386 8.57277003,5.9624414 7.85915503,6.67605648 C7.14553995,7.38967148 6.78873241,8.23474189 6.78873241,9.21126771 L6.78873241,17.6056345 C6.78873241,18.58216 7.14553995,19.4272304 7.85915503,20.1408458 C8.57277003,20.8544604 9.41784045,21.2112677 10.3943663,21.2112677 L17.6056345,21.2112677 C18.58216,21.2112677 19.4272304,20.8544604 20.1408458,20.1408458 C20.8544604,19.4272304 21.2112677,18.58216 21.2112677,17.6056345 L21.2112677,14 C21.2112677,13.6619718 21.0985918,13.3802818 20.8732399,13.1549299 C20.6478873,12.9295781 20.3661969,12.8169022 20.0281687,12.8169022 C19.6901405,12.8169022 19.3896714,12.7042258 19.1267613,12.4788732 C18.9014086,12.2159623 18.7887323,11.9154928 18.7887323,11.5774646 L18.7887323,11.5774646 Z M23.6338031,2 C24.2723005,2 24.8169014,2.24413145 25.2676059,2.73239436 C25.7558686,3.18309863 26,3.72769958 26,4.36619722 L26,23.6338031 C26,24.2723005 25.7558686,24.8356809 25.2676059,25.3239444 C24.8169014,25.7746481 24.2723005,26 23.6338031,26 L4.36619722,26 C3.7276995,26 3.16431919,25.7746481 2.67605628,25.3239444 C2.22535209,24.8356809 2,24.2723005 2,23.6338031 L2,4.36619722 C2,3.72769958 2.22535209,3.18309863 2.67605628,2.73239436 C3.16431919,2.24413145 3.7276995,2 4.36619722,2 L23.6338031,2 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    
    
    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    

    
    <a class="social-icon" href="#" target="_blank" rel="noopener" title="Google Scholar">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink">
             <path d="M15.7399177,5.48151786 C15.149924,4.82272859 14.4663239,4.49480724 13.6933878,4.49480724 C12.8185607,4.49480724 12.1471312,4.80966127 11.6791845,5.43796013 C11.2112379,6.06433732 10.9771365,6.82326666 10.9771365,7.71483354 C10.9771365,8.47423262 11.1052474,9.24733956 11.3616402,10.035649 C11.6170934,10.8236168 12.0350768,11.5270314 12.6210136,12.1470458 C13.2049434,12.7685974 13.8844439,13.0787968 14.6564833,13.0787968 C15.5171327,13.0787968 16.189459,12.7903763 16.671626,12.2137916 C17.1517432,11.6379755 17.3927199,10.9111166 17.3927199,10.035649 C17.3927199,9.29000051 17.2655484,8.50924961 17.0102233,7.69296927 C16.7561365,6.87562134 16.3319184,6.13812924 15.739875,5.48156056 L15.7399177,5.48151786 Z M24.3072528,4.96950105 L24.3072528,13.3462071 C24.3072528,13.7339989 23.9898792,14.0515006 23.6019592,14.0515006 L23.3422783,14.0515006 C22.9543156,14.0515006 22.6369848,13.7341271 22.6369848,13.3462071 L22.6369848,4.96950105 C22.6369848,4.62513879 22.5869788,4.33765779 23.068249,4.27714671 L23.068249,3.16262405 L19.3634081,6.20120253 C19.4061972,6.28058863 19.446851,6.33132057 19.4854124,6.39789556 C19.8110278,6.97418137 19.9768461,7.69087679 19.9768461,8.56681414 C19.9768461,9.23824368 19.8649625,9.84134739 19.638078,10.3740328 C19.4122611,10.9065473 19.1375912,11.3415267 18.817143,11.6765369 C18.496652,12.0127855 18.1752643,12.3201237 17.8538766,12.5967152 C17.5324462,12.8739047 17.2577763,13.162923 17.0328135,13.4629589 C16.8060571,13.7620125 16.6932767,14.0712297 16.6932767,14.3917206 C16.6932767,14.7126813 16.8397076,15.0387237 17.1317151,15.3673283 C17.4226551,15.6968724 17.7805972,16.0162103 18.2038758,16.3317049 C18.6279231,16.6450216 19.0510736,16.9928002 19.4743522,17.3712399 C19.8985703,17.74921 20.2545052,18.2354765 20.5454452,18.8259399 C20.8385631,19.4186239 20.9848231,20.071093 20.9848231,20.7882582 C20.9848231,21.7343577 20.7435475,22.5887297 20.2626616,23.3491963 C19.7802812,24.1064175 19.1518542,24.7106315 18.3796867,25.1537246 C17.6054695,25.599807 16.777531,25.9355858 15.8945476,26.1623422 C15.0097279,26.3870488 14.1317408,26.5 13.2548639,26.5 C12.7014246,26.5 12.1429889,26.4573818 11.5814359,26.3697112 C11.0178757,26.2822114 10.4532907,26.1276668 9.8847343,25.9098782 C9.31502485,25.6906377 8.81052389,25.4214338 8.37319577,25.0981672 C7.93475736,24.778146 7.58181166,24.3652016 7.3111559,23.862238 C7.04054285,23.3591036 6.90615445,22.7936645 6.90615445,22.1655364 C6.90615445,21.4203577 7.1136515,20.7291563 7.52975591,20.0847582 C7.94586031,19.4451002 8.49707907,18.9108775 9.18272893,18.487727 C10.3789864,17.7434877 12.2558547,17.2836547 14.8102164,17.1098936 C14.2262867,16.3799173 13.9333396,15.6928582 13.9333396,15.0498693 C13.9333396,14.6841125 14.0289531,14.2920503 14.218173,13.8687717 C13.9130554,13.9113899 13.5987992,13.9355175 13.2781801,13.9355175 C11.9059836,13.9355175 10.7472627,13.4894351 9.80628769,12.5911638 C8.86535538,11.6944724 8.39535897,10.5719642 8.39535897,9.21488479 C8.39535897,9.07298054 8.39941581,8.94802965 8.40970739,8.8095417 L2.83316537,8.8095417 L11.2417283,1.5 L25.1668346,1.5 L23.87996,2.50451805 L23.87996,4.27748834 C24.3577712,4.3388962 24.3072955,4.62607827 24.3072955,4.96950105 L24.3072528,4.96950105 Z M15.8172967,17.9839947 C15.6566455,17.9549562 15.430914,17.9386434 15.1399313,17.9386434 C14.512273,17.9386434 13.8947782,17.9941154 13.2885571,18.1048887 C12.6822934,18.2126727 12.084186,18.3947184 11.4941496,18.6515809 C10.9019353,18.906906 10.423996,19.2823566 10.0597766,19.7787865 C9.69355004,20.274576 9.51150436,20.858463 9.51150436,21.5303623 C9.51150436,22.1706609 9.67215551,22.7419077 9.99371402,23.2394479 C10.3142049,23.7338281 10.7373127,24.1208513 11.2632509,24.3980408 C11.7891891,24.6756999 12.3405787,24.8854176 12.916224,25.0231795 C13.4929795,25.1600875 14.0799412,25.2311463 14.6780913,25.2311463 C15.8610679,25.2311463 16.8794647,24.9647609 17.7338794,24.4320756 C18.5863724,23.899561 19.0135798,23.0772595 19.0135798,21.9672634 C19.0135798,21.7338025 18.9810823,21.5040141 18.916856,21.2796064 C18.8498112,21.0527219 18.7835352,20.8585057 18.7185829,20.6972567 C18.6534171,20.5389543 18.529363,20.3483679 18.3462498,20.1286576 C18.1642041,19.9083067 18.0248194,19.7455631 17.9310848,19.6372239 C17.8354714,19.5253403 17.6565431,19.3656714 17.3929761,19.1545445 C17.131587,18.9425209 16.9647012,18.8103104 16.8904822,18.7614574 C16.8172027,18.7100422 16.6270434,18.5711699 16.3207728,18.3458227 C16.0147157,18.1186393 15.8468903,17.9981723 15.8173394,17.983952 L15.8172967,17.9839947 Z"></path>
        </svg>
    </a>
    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="../../../js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>